# Document DB ê°œë°œí™˜ê²½ ì…‹íŒ…

<!-- TOC -->
* [Document DB ê°œë°œí™˜ê²½ ì…‹íŒ…](#document-db-ê°œë°œí™˜ê²½-ì…‹íŒ…)
  * [ğŸš¦ ê°œë°œ í™˜ê²½ ì„¤ì •](#-ê°œë°œ-í™˜ê²½-ì„¤ì •)
    * [Mongo Shell ì ‘ì† ëª…ë ì–´](#mongo-shell-ì ‘ì†-ëª…ë ì–´)
    * [SSM Connection ëª…ë ¹ì–´](#ssm-connection-ëª…ë ¹ì–´)
    * [Application ì ‘ì† URI](#application-ì ‘ì†-uri)
    * [DocumentDB Local ì ‘ì† Alias ì„¤ì •](#documentdb-local-ì ‘ì†-alias-ì„¤ì •)
  * [ğŸš¦ MongoDB Compassë¡œ DocumentDB ì ‘ì†](#-mongodb-compassë¡œ-documentdb-ì ‘ì†)
  * [MongoDB Compass Aggregations íƒ­ì—ì„œ Aggregation í…ŒìŠ¤íŠ¸](#mongodb-compass-aggregations-íƒ­ì—ì„œ-aggregation-í…ŒìŠ¤íŠ¸)
<!-- TOC -->

Sample Codeë¥¼ ì‘ì„±í•˜ê¸° ì „ì— AWS DocumentDB ë¡œ ê°œë°œí™˜ê²½ì„ ì…‹íŒ…í•´ì„œ ì§„í–‰í–ˆë˜ ë‚´ìš©ì„ ì •ë¦¬

AWS Document DBì˜ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ Private ë„ë©”ì¸ë§Œ ì œê³µë˜ë¯€ë¡œ ë¡œì»¬ì—ì„œëŠ” AWS SSMì„ í†µí•´ port forwarding í•˜ì—¬ ì ‘ì†

- ì°¸ê³ 
    - https://findstar.pe.kr/2022/09/03/accessing-private-rds-instance-using-ssm/

---

## ğŸš¦ ê°œë°œ í™˜ê²½ ì„¤ì •

### Mongo Shell ì ‘ì† ëª…ë ì–´

```shell
$ mongosh --host test-dev-docdb.cluster-cueokyhf6yae.ap-northeast-2.docdb.amazonaws.com:27017 --username username --password password
```

### SSM Connection ëª…ë ¹ì–´

```shell
$ aws ssm start-session --target i-07609be66e5800000 \
--document-name AWS-StartPortForwardingSessionToRemoteHost \
--parameters '{"portNumber":["27017"],"localPortNumber":["27017"],"host":["test-dev-docdb.cluster-cueokyhf6yae.ap-northeast-2.docdb.amazonaws.com"]}'
```

### Application ì ‘ì† URI

```shell
mongodb://username:password@localhost:27017/database?directConnection=true&replicaSet=rs0&readPreference=secondaryPreferred&retryWrites=false&w=majority
```

### DocumentDB Local ì ‘ì† Alias ì„¤ì •

ë¨¼ì € Localì— `aws-session-manager-plugin` ê°€ ì„¤ì¹˜ ë˜ì–´ ìˆì–´ì•¼ ëœë‹¤

```shell
# Localì— aws-session-manager-plugin ì„¤ì¹˜
brew install aws-session-manager-plugin
```

DocumentDB Local ì ‘ì† Aliasë¥¼ `.zshrc`ì— ì¶”ê°€

```shell
alias docdb="aws ssm start-session --target i-07609be66e5800000 \
--document-name AWS-StartPortForwardingSessionToRemoteHost \
--parameters '{\"portNumber\":[\"27017\"],\"localPortNumber\":[\"27017\"],\"host\":[\"test-dev-docdb.cluster-cueokyhf6yae.ap-northeast-2.docdb.amazonaws.com\"]}'"
```

ì´ë ‡ê²Œ ë‚˜ì˜¤ë©´ Localì—ì„œ DocumentDBì— ì ‘ì†í•  ì¤€ë¹„ê°€ ì™„ë£Œëœ ìƒíƒœ

![img.png](attachments/img1.png)

---

## ğŸš¦ MongoDB Compassë¡œ DocumentDB ì ‘ì†

DocumentDB ê°œë°œ í™˜ê²½ ì„¤ì •ì„ ë§ˆì¹˜ê³  Localì—ì„œ DocumentDB ì ‘ì†í•  ì¤€ë¹„ê°€ ëœ ìƒíƒœì—ì„œ

ì ‘ì† URIë¥¼ ì…ë ¥í•˜ê±°ë‚˜ Advanced Connection Optionsë¥¼ ì„¤ì •í•˜ê³  Connect ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì ‘ì†

`mongodb://username:password@localhost:27017/?directConnection=true&authSource=database`

![img.png](attachments/img2.png)

---

## MongoDB Compass Aggregations íƒ­ì—ì„œ Aggregation í…ŒìŠ¤íŠ¸

- ì°¸ê³ 
  - https://secretartbook.tistory.com/21

`$match`, `$lookup` ì„ ì‚¬ìš©í•œ Pipeline Queryë¥¼ êµ¬ì„±í•´ì„œ userì™€ ì—°ê´€ëœ recent_search ì™€ recent_vew ë°ì´í„°ë¥¼ Aggregation í•´ì„œ ê°€ì ¸ì˜¤ëŠ” Sample

ì½”ë“œë¡œ ì‘ì„±í•˜ê¸° ì „ì— MongoDB Compassì˜ Aggregation íƒ­ì—ì„œ Queryë¥¼ ë¨¼ì € í…ŒìŠ¤íŠ¸í•´ë³´ê³  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤

![img.png](attachments/img3.png)